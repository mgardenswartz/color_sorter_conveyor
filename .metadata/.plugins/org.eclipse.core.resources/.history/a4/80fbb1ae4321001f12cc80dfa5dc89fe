/**
 * @file PololuEncoder.cpp
 * @brief Driver for a Pololu two-channel gearmotor encoder
 * @author Max Gardenswartz
 * @date Jun 2, 2024
 */

#include "PololuEncoder.h"

PololuEncoder::PololuEncoder(
		TIM_HandleTypeDef* timer_handle
		)
		: timer_handle(timer_handle)
{
	HAL_TIM_Encoder_Start(timer_handle, TIM_CHANNEL_ALL);

}

PololuEncoder::update()
{
  	encoder_count = __HAL_TIM_GET_COUNTER(&htim5);
	encoder_delta = (int16_t) (encoder_count-encoder_last_count);
	encoder_last_count = encoder_count;

	// Handle timer overflow
	uint16_t max_count = 0xffff;
	uint16_t half_max_count = max_count/2;
	int16_t neg_half_max_count = -half_max_count;
	if (encoder_delta > half_max_count)
	{
		// We've overflowed in the negative direction
		encoder_delta -= max_count + 1;
	}
	else if (encoder_delta < neg_half_max_count)
	{
	    // We've overflowed in the positive direciton.
		encoder_delta += max_count + 1;
	}
}

PololuEncoder::~PololuEncoder() {
	// TODO Auto-generated destructor stub
}

